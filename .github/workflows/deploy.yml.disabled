name: Deploy MERN Application

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '22.18'
        cache: 'npm'
        cache-dependency-path: |
          package-lock.json
          frontend/package-lock.json

    # ----------------------------------------
    # FRONTEND BUILD
    # ----------------------------------------
    - name: Install frontend dependencies
      working-directory: ./frontend
      run: npm install

    - name: Build frontend
      working-directory: ./frontend
      run: npm run build

    - name: Deploy frontend to server
      uses: appleboy/scp-action@v0.1.5
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT }}
        source: "frontend/dist/*"
        target: "/var/www/html"
        strip_components: 2
        rm: true

    # ----------------------------------------
    # BACKEND DEPLOY
    # ----------------------------------------
    - name: Deploy backend files
      uses: appleboy/scp-action@v0.1.5
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT }}
        source: "server.js,package.json,package-lock.json,api.js,models/*"
        target: "/var/cardsServer"
        overwrite: true

    - name: Install backend dependencies and restart PM2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          cd /var/cardsServer
          
          echo "Installing backend dependencies..."
          npm install --omit=dev

          echo "Ensuring PM2 exists..."
          npm list -g pm2 || npm install -g pm2

          echo "Restarting backend..."
          pm2 reload express-server --update-env || pm2 start server.js --name "express-server"
          
          pm2 save
          nginx -s reload || true
