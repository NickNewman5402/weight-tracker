name: Deploy FormaTrack

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "npm"

      # ---------- Frontend ----------
      - name: Install frontend deps
        working-directory: frontend
        run: npm ci

      - name: Build frontend
        working-directory: frontend
        env:
          NODE_ENV: production
        run: npm run build

      # Ensure target path exists (before SCP)
      - name: Ensure frontend target exists
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            sudo mkdir -p /var/www/formatrack/frontend/dist

      # Copy the entire dist recursively
      - name: Deploy frontend build to /var/www/formatrack/frontend/dist
        uses: appleboy/scp-action@v0.1.5
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}
          source: "frontend/dist/**"
          target: "/var/www/formatrack/frontend/dist"
          rm: true


      # ---------- Package backend (root) ----------
      - name: Archive artifact
        run: |
          tar -czf formatrack.tgz \
            frontend/dist \
            package.json package-lock.json \
            server.js api.js Card_server.js createJWT.js nodemon.json \
            models

      # ---------- Upload ----------
      - name: Copy to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          port: ${{ secrets.DO_PORT }}
          key: ${{ secrets.DO_SSH_KEY }}
          source: "formatrack.tgz"
          target: "/tmp/"

      # ---------- Deploy ----------
      - name: Deploy on server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          port: ${{ secrets.DO_PORT }}
          key: ${{ secrets.DO_SSH_KEY }}
          script: |
            set -e
            APP_DIR=${{ secrets.APP_DIR:-/var/www/formatrack }}
            mkdir -p $APP_DIR
            tar -xzf /tmp/formatrack.tgz -C $APP_DIR

            cd $APP_DIR
            npm ci --omit=dev

            export NODE_ENV=production
            export MONGODB_URI='${{ secrets.FORMATRACK_MONGODB_URI }}'
            export ACCESS_TOKEN_SECRET='${{ secrets.FORMATRACK_JWT_SECRET }}'

            [ -d $APP_DIR/frontend/dist ] || (echo "Missing frontend build" && exit 1)
            [ -f $APP_DIR/server.js ] || (echo "Missing server.js in APP_DIR" && exit 1)

            pm2 startOrReload $APP_DIR/ecosystem.config.cjs --only formatrack-api --update-env || \
            pm2 start $APP_DIR/ecosystem.config.cjs --only formatrack-api --update-env
            pm2 save

            rm -f /tmp/formatrack.tgz
