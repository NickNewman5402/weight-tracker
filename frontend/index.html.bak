<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FormaTrack | Login</title>
  <link rel="icon" type="image/svg+xml" href="/vite.svg" />
  <meta name="color-scheme" content="dark" />
  <style>
    :root{
      --gold: #f9d36b;
      --gold-soft: #e8c25b;
      --bg-top: #111;
      --bg-bottom: #000;
      --text: #e6e6e6;
      --muted: #9ea1a6;
      --danger: #ff6b6b;
      --success: #69db7c;
      --ring: rgba(249, 211, 107, 0.4);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100svh;
      display: grid;
      place-items: center;
      background: radial-gradient(circle at 50% -10%, var(--bg-top) 0%, var(--bg-bottom) 60%);
      color: var(--gold);
      font-family: "Cinzel", "Trajan Pro", ui-serif, Georgia, serif;
      letter-spacing: 0.3px;
      overflow-x: hidden;
      position: relative;
    }

    /* Armor texture overlay */
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      background-image: url("https://www.transparenttextures.com/patterns/brushed-alum-dark.png");
      opacity: 0.2;
      z-index: 0;
    }

    .container {
      position: relative;
      z-index: 1;
      width: min(92vw, 1024px);
      display: grid;
      grid-template-columns: 1.1fr 1fr;
      gap: clamp(16px, 4vw, 40px);
      align-items: center;
      padding: clamp(16px, 3vw, 32px);
    }

    @media (max-width: 880px) {
      .container { grid-template-columns: 1fr; }
    }

    .hero {
      text-align: center;
      padding: clamp(12px, 2vw, 20px);
    }

    .crest {
      width: 110px;
      height: 110px;
      border: 3px solid var(--gold);
      border-radius: 50%;
      display: grid;
      place-items: center;
      margin: 0 auto 1rem;
      box-shadow: 0 0 18px rgba(255, 215, 0, 0.25), inset 0 0 18px rgba(255, 215, 0, 0.12);
      animation: crest-pulse 4s ease-in-out infinite;
      user-select: none;
    }
    .crest::before { content: "⚔️"; font-size: 2.3rem; }

    h1 {
      margin: 0.2rem 0 0.35rem;
      font-size: clamp(2rem, 4vw, 3.25rem);
      text-shadow: 0 0 12px rgba(255, 223, 0, 0.35), 0 0 34px rgba(255, 215, 0, 0.18);
      animation: glow 3s ease-in-out infinite alternate;
    }

    .tag {
      color: var(--text);
      font: 500 1rem/1.5 "Segoe UI", Roboto, system-ui, -apple-system, sans-serif;
      opacity: 0.95;
    }

    .login-card {
      background: rgba(17, 17, 17, 0.6);
      border: 1px solid rgba(249, 211, 107, 0.2);
      border-radius: 20px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.45);
      padding: clamp(16px, 3vw, 28px);
      backdrop-filter: blur(6px);
    }

    .login-title {
      margin: 0 0 0.75rem;
      font-size: 1.6rem;
      text-align: center;
      letter-spacing: 0.6px;
    }

    form {
      display: grid;
      gap: 14px;
    }

    label {
      font: 600 0.92rem/1.2 "Segoe UI", Roboto, system-ui, -apple-system, sans-serif;
      color: var(--gold-soft);
      display: inline-block;
      margin-bottom: 6px;
    }

    .field {
      position: relative;
    }

    .input {
      width: 100%;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.35);
      color: var(--text);
      outline: none;
      font: 500 1rem/1 "Segoe UI", Roboto, system-ui, -apple-system, sans-serif;
      transition: border-color 150ms, box-shadow 150ms;
    }
    .input::placeholder { color: var(--muted); }
    .input:focus {
      border-color: var(--gold);
      box-shadow: 0 0 0 3px var(--ring);
    }

    .row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-top: 6px;
    }

    .checkbox {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--text);
      font: 500 0.92rem/1.2 "Segoe UI", Roboto, system-ui, -apple-system, sans-serif;
      cursor: pointer;
      user-select: none;
    }

    .btn {
      appearance: none;
      cursor: pointer;
      border: 1px solid rgba(249, 211, 107, 0.7);
      background: linear-gradient(180deg, #2a2210, #1b160a);
      color: var(--gold);
      font: 700 1rem/1 "Segoe UI", Roboto, system-ui, -apple-system, sans-serif;
      padding: 12px 14px;
      border-radius: 12px;
      letter-spacing: 0.5px;
      transition: transform 120ms ease, box-shadow 200ms ease, filter 150ms;
      box-shadow: 0 8px 24px rgba(249, 211, 107, 0.18);
    }
    .btn:hover { transform: translateY(-1px); filter: brightness(1.06); }
    .btn:active { transform: translateY(0); }

    .link {
      color: var(--gold);
      text-underline-offset: 3px;
      text-decoration-thickness: 1px;
      font-weight: 600;
    }
    .link:focus-visible { outline: 3px solid var(--ring); border-radius: 6px; }

    .error, .success {
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.12);
      font: 600 0.95rem/1.4 "Segoe UI", Roboto, system-ui, -apple-system, sans-serif;
      color: var(--text);
    }
    .error { border-color: rgba(255,107,107,0.5); color: var(--danger); }
    .success { border-color: rgba(105,219,124,0.5); color: var(--success); }

    footer {
      margin-top: 1.2rem;
      text-align: center;
      color: var(--gold);
      font-family: "Segoe UI", Roboto, system-ui, -apple-system, sans-serif;
      font-size: 0.92rem;
      opacity: 0.9;
    }

    /* Animations */
    @keyframes glow {
      from {
        text-shadow: 0 0 10px rgba(255, 223, 0, 0.25),
                     0 0 22px rgba(255, 215, 0, 0.12);
      }
      to {
        text-shadow: 0 0 25px rgba(255, 223, 0, 0.75),
                     0 0 52px rgba(255, 215, 0, 0.35);
      }
    }
    @keyframes crest-pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .sr-only{
      position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0
    }
  </style>
</head>
<body>
  <main class="container" role="main">
    <section class="hero" aria-labelledby="welcomeHeading">
      <div class="crest" aria-hidden="true"></div>
      <h1 id="welcomeHeading">Welcome to FormaTrack</h1>
      <p class="tag">Forged at UCF — where precision meets purpose.<br/>Log in below to begin your training.</p>
      <footer>© 2025 FormaTrack • Crafted with honor and steel</footer>
    </section>

    <section class="login-card" aria-labelledby="loginHeading">
      <h2 id="loginHeading" class="login-title">Sign in to your account</h2>
      <div id="message" role="status" aria-live="polite" style="min-height: 22px;"></div>

      <form id="loginForm" novalidate>
        <div class="field">
          <label for="email">Email</label>
          <input id="email" name="email" type="email" class="input" placeholder="you@knights.ucf.edu" autocomplete="username email" required />
        </div>

        <div class="field">
          <div class="row" style="margin:0 0 6px;align-items:flex-end">
            <label for="password" style="margin:0">Password</label>
            <a class="link" href="/forgot" id="forgotLink">Forgot password?</a>
          </div>
          <input id="password" name="password" type="password" class="input" placeholder="••••••••" autocomplete="current-password" required />
          <button type="button" id="togglePwd" class="link" style="margin-top:6px;background:none;border:none;padding:0">Show password</button>
        </div>

        <div class="row">
          <label class="checkbox">
            <input id="remember" type="checkbox" />
            <span>Remember me</span>
          </label>
          <a class="link" href="/register" id="registerLink">Create account</a>
        </div>

        <button class="btn" type="submit" id="submitBtn">Sign in</button>
      </form>
    </section>
  </main>

  <script>
    // --- Config: adjust if your API path differs in prod/dev ---
    const apiBase = (location.hostname === "localhost" || location.hostname === "127.0.0.1")
      ? "http://localhost:5000/api"
      : "/api";

    const form = document.getElementById('loginForm');
    const message = document.getElementById('message');
    const submitBtn = document.getElementById('submitBtn');
    const togglePwd = document.getElementById('togglePwd');
    const pwdInput = document.getElementById('password');

    togglePwd.addEventListener('click', () => {
      const isText = pwdInput.type === 'text';
      pwdInput.type = isText ? 'password' : 'text';
      togglePwd.textContent = isText ? 'Show password' : 'Hide password';
      pwdInput.focus();
    });

    function showMessage(text, type = "error") {
      message.textContent = text;
      message.className = type === "success" ? "success" : "error";
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      message.textContent = "";
      message.className = "";
      submitBtn.disabled = true;
      submitBtn.textContent = "Signing in...";

      const email = (document.getElementById('email').value || "").trim();
      const password = (document.getElementById('password').value || "").trim();
      const remember = document.getElementById('remember').checked;

      if (!email || !password) {
        showMessage("Please enter both email and password.");
        submitBtn.disabled = false;
        submitBtn.textContent = "Sign in";
        return;
      }

      try {
        const resp = await fetch(apiBase + "/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ login: email, password })
        });

        // Handle non-JSON or text responses gracefully
        const text = await resp.text();
        let data;
        try { data = JSON.parse(text); } catch { data = { error: text }; }

        if (!resp.ok || data.error) {
          throw new Error(data.error || "Login failed");
        }

        // Expecting { firstName, lastName, id, jwtToken, error: '' }
        const { jwtToken, firstName, lastName, id } = data;

        if (!jwtToken) throw new Error("No token returned from server.");

        // Token storage (remember me => localStorage, else sessionStorage)
        const storage = remember ? localStorage : sessionStorage;
        storage.setItem("jwtToken", jwtToken);
        storage.setItem("user", JSON.stringify({ firstName, lastName, id, email }));

        showMessage("Welcome back, " + (firstName || "knight") + "!", "success");

        // Redirect to your app's dashboard/home route
        // Adjust as needed: e.g., "/app", "/dashboard", "/home"
        setTimeout(() => {
          window.location.assign("/UserHome");
        }, 600);
      } catch (err) {
        showMessage(err.message || "Unable to sign in. Please try again.");
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = "Sign in";
      }
    });
  </script>
</body>
</html>
